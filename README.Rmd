---
title: "Untitled"
output: github_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Link to github repository  

## Required Packages  

```{r setup packages results='hide'}
library(tidyverse)
library(httr)
library(jsonlite)
```

## Write functions to contact the NHL Records API  
Note -- to help with ease of tracking variable scope -- function arguments have the letter 'a' for a prefix, variables local to the function have an 'f' for a prefix.  Global variables have a 'g' prefix.
```{r Filter Functions}

convertNameToNumber<- function(aName = "")
{

  fNumber<- ""
  #If we have a name input, translate it to an ID with an API call
  if(aName != ""){
    fTeamList<- as_tibble(getFranchiseInfo())%>%filter(data.teamCommonName == aName)
    fNumber<- toString(fTeamList$data.mostRecentTeamId[1])
    #fNumber is "NA" if the team name did not exist. restore to being an empty string for silent error
    fNumber<- sub("NA", "", fNumber)
  }

  return(fNumber)
}

#Takes the final TeamID number and if it exists, formats for calls against NHL Records API
formatRecFilter_1<- function(aNumber){
  if(aNumber != "") return(paste0("?cayenneExp=mostRecentTeamId=",aNumber))
  else return ("")
}

formatRecFilter_2<- function(aNumber){
  if(aNumber != "") return(paste0("?cayenneExp=TeamId=",aNumber))
  else return ("")
}

#Takes the final TeamID number and if it exists, formats for calls against NHL Stats API 
formatStatFilter<- function(aNumber){
    if(aNumber != "") return(paste0("/",aNumber))
  else return ("")
}

#Process name and number inputs for minimal function evaluation
#Identical to evalRecCommons, different output str format
evalStatCommons<- function(aName="", aNumber = ""){
  if(aNumber=="") {
    if(aName=="") return("")
    else fNumber <- convertNameToNumber(aName)
  }
  else fNumber <- aNumber
  return(formatStatFilter(fNumber))
  
}
#Process name and number inputs for minimal function evaluation
#Identical to evalStatCommons, different output str format
evalRecCommons_1<- function(aName="", aNumber = ""){
    if(aNumber=="") {
     if(aName=="") return("")
      else fNumber <- convertNameToNumber(aName)
  }
  else fNumber <- aNumber
  return(formatRecFilter_1(fNumber))
}

evalRecCommons_2<- function(aName="", aNumber = ""){
    if(aNumber=="") {
     if(aName=="") return("")
      else fNumber <- convertNameToNumber(aName)
  }
  else fNumber <- aNumber
  return(formatRecFilter_2(fNumber))
}


```

```{r Parsed Franchise}
#input options for franchise common name and franchise team id number, number runs slightly faster
#function returns id, first seasonid, and last seasonid and name of every team in the history of the NHL
getFranchiseInfo<- function(...){
#Define API url and pull results
fBase<- "https://records.nhl.com/site/api/"
fEndpoint<- "franchise"
fCayenneExp<- evalRecCommons_1(...)
fCallURL<- paste(fBase,fEndpoint,fCayenneExp, sep="")
print(fCallURL)

#Process results into a dataframe and return
fRawJSON<- GET(fCallURL)
fJSON_text<- content(fRawJSON, "text")
fParsedText <- fromJSON(fJSON_text, flatten = TRUE)
fDF <- as.data.frame(fParsedText)

return(fDF)
}
```

```{r Parsed team totals}
#input options for franchise common name and franchise team id number, number runs slightly faster
#function Returns total stats for every franchise (ex roadTies, roadWins, etc)
getFranchiseTotals<- function(...){
#Define API url and pull results
fBase<- "https://records.nhl.com/site/api/"
fEndpoint<- "franchise-team-totals"
fCayenneExp<- evalRecCommons_2(...)
fCallURL<- paste(fBase,fEndpoint,fCayenneExp, sep="")
print(fCallURL)

#Process results into a dataframe and return
fRawJSON<- GET(fCallURL)
fJSON_text<- content(fRawJSON, "text")
fParsedText <- fromJSON(fJSON_text, flatten = TRUE)
fDF <- as.data.frame(fParsedText)

return(fDF)
}
```

```{r Parsed Franchise Season Records}
#season records for a specific franchise
#https://records.nhl.com/site/api/franchise-season-records?cayenneExp=franchiseId=ID

#example query
#/franchise-season-results?cayenneExp=franchiseId=24&sort=seasonId&dir=DESC Returns every season result for a specified team, sorted by seasonId in descending order
getFranchiseSeasonRecords<- function(...){
#Define API url and pull results
fBase<- "https://records.nhl.com/site/api/"
fEndpoint<- "franchise-season-records"
fCayenneExp<- evalRecCommons(...)
fCallURL<- paste(fBase,fEndpoint,fCayenneExp, sep="")
print(fCallURL)

#Process results into a dataframe and return
fRawJSON<- GET(fCallURL)
fJSON_text<- content(fRawJSON, "text")
fParsedText <- fromJSON(fJSON_text, flatten = TRUE)
fDF <- as.data.frame(fParsedText)

return(fDF)
}
```

```{r Parsed Goalie Records}
#Goalie records for the specified franchise 
#/franchise-goalie-records?cayenneExp=franchiseId=ID
getFranchiseGoalieRecords<- function(...){
#Define API url and pull results
fBase<- "https://records.nhl.com/site/api/"
fEndpoint<- "franchise-goalie-records"
fCayenneExp<- evalRecCommons(...)
fCallURL<- paste(fBase,fEndpoint,fCayenneExp, sep="")
print(fCallURL)

#Process results into a dataframe and return
fRawJSON<- GET(fCallURL)
fJSON_text<- content(fRawJSON, "text")
fParsedText <- fromJSON(fJSON_text, flatten = TRUE)
fDF <- as.data.frame(fParsedText)

return(fDF)
}
```


```{r Parsed Skater Records}
#/franchise-skater-records?cayenneExp=franchiseId=ID Skater records, same interaction as goalie endpoint
getFranchiseSkaterRecords<- function(...){
#Define API url and pull results
fBase<- "https://records.nhl.com/site/api/"
fEndpoint<- "franchise-skater-records"
fCayenneExp<- evalRecCommons(...)
fCallURL<- paste(fBase,fEndpoint,fCayenneExp, sep="")
print(fCallURL)

#Process results into a dataframe and return
fRawJSON<- GET(fCallURL)
fJSON_text<- content(fRawJSON, "text")
fParsedText <- fromJSON(fJSON_text, flatten = TRUE)
fDF <- as.data.frame(fParsedText)

return(fDF)
}
```

```{r TestRecordsAPI}
gdfFranchiseAll<-getFranchiseInfo()
as_tibble(gdfFranchiseAll)%>% 

gdfFranchiseName<-getFranchiseInfo(aName="Devils")
gdfFranchiseNumber<-getFranchiseInfo(aNumber=2)

gdfFranTotal<-getFranchiseTotals()
gdfFranTotalName<-getFranchiseTotals(aName="Devils")
gdfFranTotalNumber<-getFranchiseTotals(aNumber=2)

gdfFranSeas<-getFranchiseSeasonRecords()
gdfFranSeasName<-getFranchiseSeasonRecords(aName="Devils")
gdfFranSeasNum<-getFranchiseSeasonRecords(aNumber=2)

gdfFranGoal<-getFranchiseGoalieRecords()
gdfFranGoalName<-getFranchiseGoalieRecords(aName="Devils")
gdfFranGoalNum<-getFranchiseGoalieRecords(aNumber=2)

gdfFranSkat<-getFranchiseSkaterRecords()
gdfFranSkatName<-getFranchiseSkaterRecords(aName="Devils")
gdfFranSkatNum<-getFranchiseSkaterRecords(aNumber=2)

write.csv(gdfFranchiseAll, "franchise.csv")
write.csv(gdfFranTotal,"franTotals.csv")
write.csv(gdfFranSeas,"franSeason.csv")
write.csv(gdfFranGoal,"franGoalie.csv")
write.csv(gdfFranSkat, "franSkat.csv")

```
```{r Stats Filter}
#Need a different filter function for the different API set.
#This version needs to resolve 
```
```{r Stats API All}
#You should have a function to return parsed data for the following endpoint from the stats API(the user should be able to specify values for any of the eight modifiers listed):âˆ—https://statsapi.web.nhl.com/api/v1/teams

#aExpand can take the following values, pulling different summary expansions:
  #"Roster", "EZRoster", "NextSched","PrevSched","Stats", "TeamList",  ""
  #Note that the TeamList value needs valid teamIDs, and that the common inputs of aName and aNumber supersede this command

#aSeason is a string formatted Y111Y222 restricting the pull to the season of interest.
#By default, an empty string will pull the current season where applicable
#Example:  20142015 to refer to the 2014-2015 hockey season.

#aTeams is a comma separated string of teamIDs and requires the 'TeamList' expansion instruction 
#Note that the common inputs of aName and aNumber supersede this field
#Example: "4,5,29"

getTeamStats<- function(aExpand="", aSeason = "", aTeams = "", ...){

  fTeamStr<- evalStatCommons(...)
  
  #Process aExpand and aTeams where relevant
  fExpand<- switch(toupper(aexpand), "ROSTER" = "?expand=team.roster", "EZROSTER" = "?expand=person.names", 
         "NEXTSCHED" = "?expand=team.schedule.next", "PREVSCHED" = "?expand=team.schedule.previous", 
         "STATS" = "?expand=team.stats", "TEAMLIST" = paste0("?teamId=", aTeams), ""="")
  
  #process aSeason
  fSeason=if(aSeason != ""){
    #If we already have a modifier, we need to tack this on with an &
    if(fExpand!="") paste0("&season=", aSeason)
    #else we need to use this as a raw modifier
    else paste0("?season=", aSeason)
  }

  #Define API url and pull results
  fBase<- "https://statsapi.web.nhl.com/api/v1/"
  fEndpoint<- "teams"

  fCallURL<- paste(fBase,fEndpoint,fExpand,fSeason,sep="")
  print(fCallURL)

  #Process results into a dataframe and return
  fRawJSON<- GET(fCallURL)
  fJSON_text<- content(fRawJSON, "text")
  fParsedText <- fromJSON(fJSON_text, flatten = TRUE)
  fDF <- as.data.frame(fParsedText)

return(fDF)
}

```

```{r One-Stop-Wrapper Function}
```

##Example Analysis


## GitHub Documents

This is an R Markdown format used for publishing markdown documents to GitHub. When you click the **Knit** button all R code chunks are run and a markdown file (.md) suitable for publishing to GitHub is generated.

## Including Code

You can include R code in the document as follows:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
